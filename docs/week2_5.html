<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Feature Engineering – PSYC559: Applied Machine Learning in Psychology</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b53751a350365c71b6c909e95f209ed1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7b8ddda7af1c99188329f288f0306ccf.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./week2_1.html">Introduction to Machine Learning</a></li><li class="breadcrumb-item"><a href="./week2_5.html">Feature Engineering</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">PSYC559: Applied Machine Learning in Psychology</a> 
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Table of Contents</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Introduction to R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week1_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic R Programming</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week1_1b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R Packages</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week1_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reading in Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week1_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Describing Data Numerically</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week1_4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Describing Data Visually</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Introduction to Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week2_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Important Terms and Distinctions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week2_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Classes in ML</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week2_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Splitting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week2_4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bias and Variance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week2_5.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Feature Engineering</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview-of-feature-engineering" id="toc-overview-of-feature-engineering" class="nav-link active" data-scroll-target="#overview-of-feature-engineering">Overview of Feature Engineering</a></li>
  <li><a href="#feature-engineering-and-data-leakage" id="toc-feature-engineering-and-data-leakage" class="nav-link" data-scroll-target="#feature-engineering-and-data-leakage">Feature Engineering and Data Leakage</a></li>
  <li><a href="#outline-of-remaining-sections" id="toc-outline-of-remaining-sections" class="nav-link" data-scroll-target="#outline-of-remaining-sections">Outline of Remaining Sections</a></li>
  <li><a href="#example-data" id="toc-example-data" class="nav-link" data-scroll-target="#example-data">Example Data</a></li>
  <li><a href="#addressing-missing-data" id="toc-addressing-missing-data" class="nav-link" data-scroll-target="#addressing-missing-data">Addressing Missing Data</a></li>
  <li><a href="#missing-data-mechanisms" id="toc-missing-data-mechanisms" class="nav-link" data-scroll-target="#missing-data-mechanisms">Missing Data Mechanisms</a></li>
  <li><a href="#handling-missing-data-in-r" id="toc-handling-missing-data-in-r" class="nav-link" data-scroll-target="#handling-missing-data-in-r">Handling Missing Data in R</a></li>
  <li><a href="#missing-data-activity" id="toc-missing-data-activity" class="nav-link" data-scroll-target="#missing-data-activity">Missing Data Activity</a></li>
  <li><a href="#handling-missing-data" id="toc-handling-missing-data" class="nav-link" data-scroll-target="#handling-missing-data">Handling Missing Data</a></li>
  <li><a href="#feature-filtering" id="toc-feature-filtering" class="nav-link" data-scroll-target="#feature-filtering">Feature Filtering</a></li>
  <li><a href="#removing-low-variance-features" id="toc-removing-low-variance-features" class="nav-link" data-scroll-target="#removing-low-variance-features">Removing Low-Variance Features</a></li>
  <li><a href="#numeric-feature-engineering" id="toc-numeric-feature-engineering" class="nav-link" data-scroll-target="#numeric-feature-engineering">Numeric Feature Engineering</a></li>
  <li><a href="#skewness" id="toc-skewness" class="nav-link" data-scroll-target="#skewness">Skewness</a></li>
  <li><a href="#standardization" id="toc-standardization" class="nav-link" data-scroll-target="#standardization">Standardization</a></li>
  <li><a href="#categorical-feature-engineering" id="toc-categorical-feature-engineering" class="nav-link" data-scroll-target="#categorical-feature-engineering">Categorical Feature Engineering</a></li>
  <li><a href="#lumping" id="toc-lumping" class="nav-link" data-scroll-target="#lumping">Lumping</a></li>
  <li><a href="#one-hot-and-dummy-encoding" id="toc-one-hot-and-dummy-encoding" class="nav-link" data-scroll-target="#one-hot-and-dummy-encoding">One-Hot and Dummy Encoding</a></li>
  <li><a href="#workflow" id="toc-workflow" class="nav-link" data-scroll-target="#workflow">Workflow</a></li>
  <li><a href="#workflow-in-r" id="toc-workflow-in-r" class="nav-link" data-scroll-target="#workflow-in-r">Workflow in R</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./week2_1.html">Introduction to Machine Learning</a></li><li class="breadcrumb-item"><a href="./week2_5.html">Feature Engineering</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Feature Engineering</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview-of-feature-engineering" class="level2" style="color: yellow">
<h2 class="anchored" data-anchor-id="overview-of-feature-engineering">Overview of Feature Engineering</h2>
</section>
<p>Feature engineering in machine learning typically describes the process of creating, transforming, or selecting variables (features) from raw data to improve a model’s performance.</p>
<p>For example, one aspect of feature engineering is feature creation. This often means transforming raw data into meaningful inputs that better capture the underlying patterns the model needs to learn. For example, suppose we are trying to predict medicine adherence (whether or not someone takes their medicine). Our raw data may contain timestamps of when someone actually takes their medicine. We might use this timestamp to create new features for our model. For example, we might add features representing <em>day of the week</em>, <em>holiday</em> or <em>weekend</em> to provide additional context to the model.</p>
<p><strong>A number of domains fall under feature engineering:</strong></p>
<ul>
<li><p>Missing data handling</p></li>
<li><p>Feature creation</p></li>
<li><p>Feature transformations</p></li>
<li><p>Screening or feature selection</p></li>
<li><p>Dimension reduction</p></li>
</ul>
<section id="feature-engineering-and-data-leakage" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="feature-engineering-and-data-leakage">Feature Engineering and Data Leakage</h3>
</section>
<p>Data leakage occurs when information from outside the training data set is used to create the model.</p>
<p>Data leakage often occurs during feature engineering.</p>
<p>To minimize data leaking, we will often want to do our feature engineering during the resampling, or data splitting, procedure we are using. To visualize this take a look at the graphic below from <span class="citation" data-cites="handson">Boehmke and Greenwell (<a href="#ref-handson" role="doc-biblioref">2019</a>)</span> where the pre-processing, or data engineering tasks, occur during each iteration. Keep this in mind as we introduce each feature engineering task.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/minimize-leakage.png" class="img-fluid figure-img" width="800"></p>
<figcaption>https://bradleyboehmke.github.io/HOML/images/minimize-leakage.png</figcaption>
</figure>
</div>
<section id="outline-of-remaining-sections" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="outline-of-remaining-sections">Outline of Remaining Sections</h3>
</section>
<ol type="1">
<li><p>Example Data</p></li>
<li><p>Addressing Missing Data</p></li>
</ol>
<section id="example-data" class="level2" style="color: yellow">
<h2 class="anchored" data-anchor-id="example-data">Example Data</h2>
</section>
<p>To demonstrate feature engineering we will use some example data from the <a href="https://gss.norc.org/">The General Social Survey (GSS)</a>.</p>
<p>GSS is a long-running, nationally representative survey of adults in the United States that has been conducted almost every two years since 1972 by the <a href="https://www.norc.org/">National Opinion Research Center (NORC)</a> at the University of Chicago. The GSS data is often used to measure American’s attitudes, behaviors, and beliefs on a wide range of topics—such as politics, religion, crime, race relations, family, work, and technology.</p>
<p>There are two ways to access the GSS data. One is using the <a href="#0">GSS Data Explorer</a>. Another option is using the <code>gssr</code> <span class="citation" data-cites="gssr">(<a href="#ref-gssr" role="doc-biblioref">Healy 2023</a>)</span> R package. Here we will use the <code>gssr</code> <span class="citation" data-cites="gssr">(<a href="#ref-gssr" role="doc-biblioref">Healy 2023</a>)</span> package to download some example data.</p>
<p>We will start by choosing <code>happy</code> as our target variable. This comes from Question 157 of the 2024 GSS where respondents were asked:</p>
<blockquote class="blockquote">
<p>Taken all together, how would you say things are these days - would you say that you are very happy, pretty happy, or not too happy?</p>
</blockquote>
<p>Responses were coded such that 1 indicates “very happy”, 2 indicates “pretty happy”, and 3 indicates “not too happy”, while NA indicates “don’t know.”</p>
<p>We can also identify ad bunch of features we think predict self-reported happiness and save our final dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gssr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Package loaded. To attach the GSS data, type data(gss_all) at the console.
For the panel data and documentation, type e.g. data(gss_panel08_long) and data(gss_panel_doc).
For help on a specific GSS variable, type ?varname at the console.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>gss24 <span class="ot">&lt;-</span> <span class="fu">gss_get_yr</span>(<span class="dv">2024</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Fetching: https://gss.norc.org/documents/stata/2024_stata.zip</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>target <span class="ot">&lt;-</span> <span class="st">"happy"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>features <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"age"</span>,     <span class="co"># age of participant</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sex"</span>,     <span class="co"># sex of participant</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race"</span>,    <span class="co"># race of participant</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"educ"</span>,    <span class="co"># highest education completed by participant</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"income"</span>,  <span class="co"># income of participant</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"childs"</span>,  <span class="co"># number of children participant has</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wrkstat"</span>, <span class="co"># work force status</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"marital"</span>, <span class="co"># marital status</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"born"</span>,    <span class="co"># whether or not participant was born in USA</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"partyid"</span>, <span class="co"># political party of participant</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"adults"</span>,  <span class="co"># num of fam members 18 or older</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"earnrs"</span>   <span class="co"># number of earners in family  </span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> gss24[,<span class="fu">c</span>(target, features)]</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data<span class="sc">$</span>happy, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   1    2    3 &lt;NA&gt; 
 684 1892  705   28 </code></pre>
</div>
</div>
<p>Next, let’s clean up <code>data</code> a bit, discarding some of the labels and missing value information we don’t need. The data in <code>gss24</code> retains the labeling structure provided by the GSS. Variables are stored numerically with labels attached to them. Often, when using the data in R, it will be convenient to convert the categorical variables we are interested in to character or factor type instead.</p>
<p>Here we can use code from the <a href="https://kjhealy.github.io/gssr/articles/overview.html">gssr package introduction</a> to simplify this recoding. The only thing we need to do is define the categorical variables in our data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sex"</span>,<span class="st">"race"</span>, <span class="st">"educ"</span>, <span class="st">"wrkstat"</span>, <span class="st">"marital"</span>, <span class="st">"born"</span>, <span class="st">"partyid"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>capwords <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">strict =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    cap <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">paste</span>(<span class="fu">toupper</span>(<span class="fu">substring</span>(x, <span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                  {x <span class="ot">&lt;-</span> <span class="fu">substring</span>(x, <span class="dv">2</span>); <span class="cf">if</span>(strict) <span class="fu">tolower</span>(x) <span class="cf">else</span> x},</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">sep =</span> <span class="st">""</span>, <span class="at">collapse =</span> <span class="st">" "</span> )</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="fu">strsplit</span>(x, <span class="at">split =</span> <span class="st">" "</span>), cap, <span class="at">USE.NAMES =</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(x)))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert all missing to NA</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">everything</span>(), haven<span class="sc">::</span>zap_missing), </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make all categorical variables factors and relabel nicely</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">all_of</span>(cat_vars), forcats<span class="sc">::</span>as_factor),</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">all_of</span>(cat_vars), \(x) forcats<span class="sc">::</span><span class="fu">fct_relabel</span>(x, capwords, <span class="at">strict =</span> <span class="cn">TRUE</span>))</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="addressing-missing-data" class="level2" style="color: yellow">
<h2 class="anchored" data-anchor-id="addressing-missing-data">Addressing Missing Data</h2>
</section>
<p>Dealing with missing data in a consistent manner is one of the most important aspects of feature engineering.</p>
<section id="missing-data-mechanisms" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="missing-data-mechanisms">Missing Data Mechanisms</h3>
</section>
<p>Much attention is paid to the mechanisms producing missing data in the statistics and applied sciences literature.</p>
<p>Knowing how the missing data came about is critical for knowing how to handle it in a subsequent analysis.</p>
<p>Although attention to missing data mechanisms has historically not been a primary focus in the ML literature, this has been changing.</p>
<p>A common framework for understanding missing data mechanisms was described by Rubin <span class="citation" data-cites="rubin1976">(<a href="#ref-rubin1976" role="doc-biblioref">1976</a>)</span>. Here we will briefly describe these mechanisms in the context of our current data example.</p>
<section id="missing-completely-at-random-mcar" class="level4" style="color: lightyellow">
<h4 class="anchored" data-anchor-id="missing-completely-at-random-mcar">Missing Completely at Random (MCAR)</h4>
</section>
<p><strong>In MCAR, the probability of a value being missing is unrelated to the value itself or any other observed or unobserved variable.</strong> This is a purely random and unsystematic process.&nbsp;</p>
<p>Imagine a cat opening up your dataset in Excel and walking across the keyboard, randomly deleting different cells.</p>
<p><strong>Definition:</strong> Missingness in self-reported happiness, for example, is unrelated to the respondent’s true happiness level or any other variables.</p>
<p><strong>Example:</strong> Let’s say there is a glitch in the online GSS survey and for some respondent’s questions are randomly skipped. This means the probability of missingness is purely random, and it does not depend on other variables (e.g.&nbsp;income, age, or happiness levels).</p>
<p><strong>Implication:</strong> Dropping these cases (listwise deletion) or using simple imputation will not bias the results, although efficiency is reduced.</p>
<section id="missing-at-random-mar" class="level4" style="color: lightyellow">
<h4 class="anchored" data-anchor-id="missing-at-random-mar">Missing at Random (MAR)</h4>
</section>
<p><strong>In MAR, the probability of a value being missing is systematically related to other observed variables in the dataset, but not to the unobserved value itself.</strong></p>
<p><strong>Definition:</strong> Missingness in happiness depends on <em>other observed variables</em> but not directly on happiness itself.</p>
<p><strong>Example:</strong> Suppose in the GSS, individuals with higher incomes were less likely to answer the happiness question. Missingness on happiness is explained by <em>income</em>, which is observed. Conditional on income (having income in our model as a predictor), the probability of missingness does not depend how happy one is.</p>
<p><strong>Implication:</strong> Methods like multiple imputation (MICE), missForest, or regression-based imputation can use income (and other observed covariates like marital status, education) to predict and impute missing happiness values without bias.</p>
<section id="missing-not-at-random-mnar" class="level4" style="color: lightyellow">
<h4 class="anchored" data-anchor-id="missing-not-at-random-mnar">Missing Not at Random (MNAR)</h4>
</section>
<p><strong>Definition:</strong> Missingness in happiness depends on the unobserved happiness score itself.</p>
<p><strong>Example:</strong> Respondents who are very unhappy may avoid answering the happiness question because it feels too personal, while those who are extremely happy may skip it because they consider it obvious. Missingness is directly tied to the unreported happiness level.</p>
<p><strong>Implication:</strong> Standard imputation methods will be biased. Handling MNAR requires explicitly modeling the missingness mechanism (e.g., selection models, pattern-mixture models)</p>
<section id="handling-missing-data-in-r" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="handling-missing-data-in-r">Handling Missing Data in R</h3>
</section>
<p>Often a first step in handling missing data involves recoding missing values as <code>NA</code>. Writing bespoke code to handle the different types of missing data one might encounter is tedious and unnecessary.</p>
<p>The <code>naniar</code> <span class="citation" data-cites="naniar">(<a href="#ref-naniar" role="doc-biblioref">Tierney and Cook 2023</a>)</span> package in R contains many convenience functions for managing missing data in R. Here we demonstrate some of that functionality.</p>
<section id="recoding-values-with-na" class="level4" style="color: lightyellow">
<h4 class="anchored" data-anchor-id="recoding-values-with-na">Recoding Values with <code>NA</code></h4>
</section>
<p>Now that we have a dataset with missing values we can use <code>naniar</code> to recode these values to <code>NA</code>. In our current data example this is already done, but this code might be useful for other projects where you import data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>gss_na_codes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"&lt;NA&gt;"</span>, <span class="sc">-</span><span class="dv">99</span>, <span class="sc">-</span><span class="dv">999</span>, <span class="st">"NA"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> naniar<span class="sc">::</span><span class="fu">replace_with_na_all</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  data, <span class="at">condition =</span> <span class="sc">~</span>.x <span class="sc">%in%</span> gss_na_codes</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>See the <a href="https://cran.r-project.org/web/packages/naniar/vignettes/replace-with-na.html"><code>naniar</code> vignette on recoding NA values</a> for more detailed information on the package functionality.</p>
<section id="missing-data-visualization" class="level4" style="color: lightyellow">
<h4 class="anchored" data-anchor-id="missing-data-visualization">Missing Data Visualization</h4>
</section>
<p>Once we have recoded our data in a consistent manner we can use visualizations to explore the missing data. The <code>vis_miss()</code> function from <code>naniar</code> is a good starting point for visualizing the amount of missing data in our dataset. The plots shows the missing values in black and non-missing values in gray. In addition, percentages of missing data in both the dataset and individual variables are provided.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week2_5_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It is often useful to look at combinations of missingness among different variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">gg_miss_upset</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week2_5_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also look at the percentage of missing data across a factor variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">gg_miss_fct</span>(<span class="at">x =</span> data, <span class="at">fct =</span> marital)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week2_5_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Many missing data visualizations are described in the <a href="https://cran.r-project.org/web/packages/naniar/vignettes/naniar-visualisation.html"><code>naniar</code> vignette on missing data visualization</a> including plots for exploring missing data mechanisms.</p>
<section id="missing-data-activity" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="missing-data-activity">Missing Data Activity</h3>
</section>
<p>Below is a small dataset looking at predictors of happiness. Some values are missing.</p>
<p>In small groups please speculate on why each value might be missing and which type of missing data mechanism it represents: MCAR, MAR, or MNAR.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns: id, happiness (target), age (feature), income (feature), education (feature)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># NA indicates missing values</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>example_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">happiness =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">8</span>, <span class="dv">5</span>, <span class="cn">NA</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="cn">NA</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">7</span>, <span class="cn">NA</span>, <span class="dv">4</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> <span class="fu">c</span>(<span class="dv">25</span>, <span class="cn">NA</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">22</span>, <span class="dv">35</span>, <span class="cn">NA</span>, <span class="dv">29</span>, <span class="dv">31</span>, <span class="dv">28</span>, <span class="dv">34</span>, <span class="cn">NA</span>, <span class="dv">27</span>, <span class="dv">33</span>, <span class="dv">26</span>),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">income =</span> <span class="fu">c</span>(<span class="dv">50000</span>, <span class="dv">55000</span>, <span class="dv">6500</span>, <span class="dv">70000</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="dv">62000</span>, <span class="cn">NA</span>, <span class="dv">45000</span>, <span class="dv">52000</span>, <span class="cn">NA</span>, <span class="dv">58000</span>, <span class="cn">NA</span>,<span class="dv">61000</span>),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">education =</span> <span class="fu">c</span>(<span class="st">"Bachelor"</span>,<span class="st">"Bachelor"</span>,<span class="st">"Master"</span>,<span class="st">"Master"</span>,<span class="st">"HighSchool"</span>,<span class="st">"Bachelor"</span>,<span class="st">"HighSchool"</span>,<span class="st">"Master"</span>,<span class="st">"Bachelor"</span>,<span class="st">"HighSchool"</span>,<span class="st">"Master"</span>,<span class="st">"Master"</span>,<span class="st">"Bachelor"</span>,<span class="st">"HighSchool"</span>,<span class="st">"Bachelor"</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>example_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   id happiness age income  education
1   1        NA  25  50000   Bachelor
2   2         8  NA  55000   Bachelor
3   3         5  30   6500     Master
4   4        NA  40  70000     Master
5   5         6  22     NA HighSchool
6   6         9  35     NA   Bachelor
7   7         4  NA     NA HighSchool
8   8         7  29  62000     Master
9   9        NA  31     NA   Bachelor
10 10         5  28  45000 HighSchool
11 11         6  34  52000     Master
12 12         8  NA     NA     Master
13 13         7  27  58000   Bachelor
14 14        NA  33     NA HighSchool
15 15         4  26  61000   Bachelor</code></pre>
</div>
</div>
<section id="handling-missing-data" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="handling-missing-data">Handling Missing Data</h3>
</section>
<p>There are a number of ways to handle missing data. Below I will discuss some of the most common ways of addressing missing data.</p>
<section id="listwise-deletion" class="level4" style="color: lightyellow">
<h4 class="anchored" data-anchor-id="listwise-deletion">Listwise Deletion</h4>
</section>
<p>Listwise deletion (also called complete-case analysis) is one of the simplest methods for handling missing data in a dataset.</p>
<p>When performing listwise deletion we remove any row that has one or more missing values across any variable used in the analysis.</p>
<p>After deletion, only rows that are complete for all variables remain.</p>
<p>For example, our example GSS data has <code>3,309</code> rows before we address the missing data. If we only kept rows that contained no missing data we would have <code>2,780</code> observations. You can perform listwise deletion on your data using the <code>complete.cases()</code> function as demonstrated below. Then you can visualize the missing data to ensure there is no missingness on the new dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># nrow(data) # 3,3309 rows</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>data_cc <span class="ot">&lt;-</span> data[<span class="fu">complete.cases</span>(data),]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(data_cc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2746</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(data_cc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week2_5_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, listwise deletion should really only be used if data is missing completely at random (MCAR). In this case it can still provide unbiased results, although they can be less efficient (reduced power and more uncertainty).</p>
<section id="imputation" class="level4" style="color: lightyellow">
<h4 class="anchored" data-anchor-id="imputation">Imputation</h4>
</section>
<p>Imputation is the process of filling in missing values in a dataset with estimated or predicted values so that you can perform analyses without dropping incomplete cases.</p>
<p>Unlike listwise deletion, imputation retains all observations, reducing data loss. Imputation can be simple (deterministic, like a mean) or more involved (stochastic, model-based).</p>
<p><strong>Estimated Statistic</strong></p>
<p>A simple approach to imputing missing values for a feature is to compute descriptive statistics such as the mean, median, or mode (for categorical) and use that value to replace the <code>NA</code> values.</p>
<p>Although computationally efficient, this approach does not consider any other attributes for a given observation when imputing.</p>
<p>The <code>tidymodels</code> <span class="citation" data-cites="tidymodels">(<a href="#ref-tidymodels" role="doc-biblioref">Kuhn and Wickham 2020</a>)</span> R package has a number of useful functions for machine learning. Here we use the package to perform mean imputation on our dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────────── tidymodels 1.4.1 ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ broom        1.0.9     ✔ rsample      1.3.1
✔ dials        1.4.2     ✔ tailor       0.1.0
✔ ggplot2      3.5.2     ✔ tidyr        1.3.1
✔ infer        1.0.9     ✔ tune         2.0.0
✔ modeldata    1.5.1     ✔ workflows    1.3.0
✔ parsnip      1.3.3     ✔ workflowsets 1.1.1
✔ purrr        1.1.0     ✔ yardstick    1.3.2
✔ recipes      1.3.1     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ purrr::discard() masks scales::discard()
✖ dplyr::filter()  masks stats::filter()
✖ dplyr::lag()     masks stats::lag()
✖ recipes::step()  masks stats::step()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a recipe</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(happy <span class="sc">~</span> ., <span class="at">data =</span> data) <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mean</span>(<span class="fu">all_numeric_predictors</span>())  <span class="sc">%&gt;%</span> </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_factor_predictors</span>())</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># apply mean imputation to predictors</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># prep the recipe (estimates imputation values)</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>rec_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(rec)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># check the imputed values</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>data_mi <span class="ot">&lt;-</span> <span class="fu">bake</span>(rec_prep, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(data_mi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week2_5_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>K-Nearest Neighbor</strong></p>
<p>Another popular method for performing imputation is k-nearest neighbor.</p>
<p>Now, instead of just filling in a missing value with a simple number like the mean, KNN looks for other respondents who are most similar (the “nearest neighbors”) and uses their information to fill in the blank.</p>
<p><strong>How KNN Imputation Works</strong></p>
<ol type="1">
<li><strong>Measure similarity</strong>
<ul>
<li>For the student with a missing value, KNN looks at the other variables (educ, martial, partyid).<br>
</li>
<li>It finds the <em>k</em> students who are most “similar” (closest in the data space).</li>
</ul></li>
<li><strong>Borrow information</strong>
<ul>
<li>If we set <code>k = 3</code>, the algorithm finds the 3 most similar students.<br>
</li>
</ul></li>
<li><strong>Fill in the blank</strong>
<ul>
<li>It might take the average of those 3 scores and use that as the imputed value.</li>
<li>Or, depending on settings, it could pick a weighted average (closer neighbors count more).</li>
</ul></li>
</ol>
<p><strong>Better than Mean Imputation?</strong></p>
<p>Think of guessing someone’s favorite pizza topping:</p>
<ul>
<li><strong>Mean imputation</strong>: “Most people like pepperoni, so I’ll assume this person does too.”<br>
</li>
<li><strong>KNN imputation</strong>: This person is very similar to Iris, Naomi, Owen, Naveen, and Stella who all like pineapply. Instead, I’ll assume they probably like pineapple.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create a recipe</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(happy <span class="sc">~</span> ., <span class="at">data =</span> data) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>())   </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># apply mean imputation to predictors</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># prep the recipe (estimates imputation values)</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>rec_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(rec)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co"># check the imputed values</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>data_knn <span class="ot">&lt;-</span> <span class="fu">bake</span>(rec_prep, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(data_knn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week2_5_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Tree-Based Imputation</strong></p>
<p>Tree-based imputation methods use decision trees (or random forests) to predict missing values based on the other variables in the dataset. Similar to KNN methods, tree-based methods make a tailored prediction using patterns in the data.</p>
<p>Tree-based methods are especially nice for imputation as they handle non-linearities and interactions, and can accomodate mixed data types, like continuous and categorical variables.</p>
<p><strong>How Tree-Based Imputation Works</strong></p>
<ol type="1">
<li><strong>Treat the missing variable like an outcome</strong>
<ul>
<li>Suppose some people are missing their <em>income</em>.</li>
<li>A tree is trained to predict income from other available variables (like education, age, occupation).</li>
</ul></li>
<li><strong>Learn patterns in the data</strong>
<ul>
<li>The tree splits the dataset into groups that have similar income levels.</li>
<li>For example:
<ul>
<li><em>If education &gt; 16 years → higher income group</em></li>
<li><em>If education ≤ 16 and occupation = retail → lower income group</em></li>
</ul></li>
</ul></li>
<li><strong>Predict the missing values</strong></li>
</ol>
<ul>
<li>For a person with missing income, the model uses their other information (education, age, etc.) to drop them into the right “leaf” of the tree.</li>
<li>The average (or majority class, if categorical) in that leaf is used as the imputed value.</li>
</ul>
<p><strong>Better than Mean Imputation?</strong></p>
<p>Think of tree-based imputation like asking:</p>
<blockquote class="blockquote">
<p><em>“Given your age, job, and education, people like you usually make about X — so we’ll use that as your missing value.”</em></p>
</blockquote>
<p>This is smarter than saying <em>“everyone makes the same average income”</em> (mean imputation) or even <em>“let’s just look at your 3 closest neighbors”</em> (KNN).</p>
<section id="feature-filtering" class="level2" style="color: yellow">
<h2 class="anchored" data-anchor-id="feature-filtering">Feature Filtering</h2>
</section>
<p>Feature filtering is a feature selection technique in machine learning where features are evaluated prior to the model fitting based on statistical or heuristic criteria. Features are then kept or discarded based on those criteria.</p>
<p>It is called filtering because it is a preprocessing step, part of a feature engineering pipeline, done before we actually train the model.</p>
<p>Typically, the goals of feature filtering are:</p>
<ol type="1">
<li><p><strong>Reduce dimensionality:</strong> Fewer features means simpler models, faster training, and less risk of overfitting.</p></li>
<li><p><strong>Remove irrelevant or redundant features:</strong> Avoids feeding the model noisy or useless inputs.</p></li>
<li><p><strong>Improve interpretability:</strong> Models are easier to understand when they focus only on meaningful features.</p></li>
<li><p><strong>Boost performance:</strong> Better generalization on new data when unnecessary features are excluded.</p></li>
</ol>
<p>In practice, one of the filtering tasks we will typically conduct involves weeding out low variance features.</p>
<section id="removing-low-variance-features" class="level3" style="color:orange">
<h3 style="color:orange" class="anchored" data-anchor-id="removing-low-variance-features">Removing Low-Variance Features</h3>
</section>
<p>Zero and near-zero variance variables are low-hanging fruit to eliminate.</p>
<ul>
<li><p><strong>Zero Variance Features</strong>: variable only contains a single unique value</p></li>
<li><p><strong>Near-Zero Variance Features</strong>: variable contains only a few unique values</p></li>
</ul>
<p>Zero and near-zero variance variables typically offer little to no information for model building. Furthermore, resampling (data-splitting) further complicates this picture because a given fold or sample may only contain a single value if the variable itself only contains a few unique values.</p>
<p><span class="citation" data-cites="handson">Boehmke and Greenwell (<a href="#ref-handson" role="doc-biblioref">2019</a>)</span> suggest the following rule-of-thumb for removing low-variance features:</p>
<p><strong>Remove a variable if:</strong></p>
<ul>
<li><p>The fraction of unique values over the sample size is low (e.g.&nbsp;10%).</p></li>
<li><p>The ratio of the frequency of the most prevalent value to the frequency of the second most prevalent value is large (e.g.&nbsp;≥20).</p></li>
</ul>
<p>We can use the <code>caret</code> <span class="citation" data-cites="caret">(<a href="#ref-caret" role="doc-biblioref">Kuhn and Max 2008</a>)</span> package in R to look at these different metrics for our example data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">nearZeroVar</span>(data, <span class="at">saveMetrics =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   rowname freqRatio percentUnique zeroVar   nzv
1    happy  2.683688    0.09066183   FALSE FALSE
2      age  1.014085    2.17588395   FALSE FALSE
3      sex  1.242672    0.06044122   FALSE FALSE
4     race  3.986014    0.09066183   FALSE FALSE
5     educ  1.191964    0.63463282   FALSE FALSE
6   income 12.948571    0.36264733   FALSE FALSE
7   childs  1.209166    0.27198549   FALSE FALSE
8  wrkstat  1.834171    0.24176488   FALSE FALSE
9  marital  1.287063    0.15110305   FALSE FALSE
10    born  6.618056    0.06044122   FALSE FALSE
11 partyid  1.558271    0.24176488   FALSE FALSE
12  adults  1.075205    0.18132366   FALSE FALSE
13  earnrs  1.560570    0.12088244   FALSE FALSE</code></pre>
</div>
</div>
<section id="numeric-feature-engineering" class="level2" style="color: yellow">
<h2 class="anchored" data-anchor-id="numeric-feature-engineering">Numeric Feature Engineering</h2>
</section>
<p>Feature engineering on continuous or numeric features involves transforming the raw data to make it more useful for modeling. Common motivations include capturing nonlinear relationships (e.g., log or polynomial transforms), improving distributional properties (reducing skew or outlier impact), and putting features on comparable scales through standardization.</p>
<p>In some cases, continuous variables are binned into categories or combined into interactions to highlight patterns. Overall, these transformations help models detect structure in the data more effectively and improve both performance and interpretability.</p>
<section id="skewness" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="skewness">Skewness</h3>
</section>
<p>Parametric models with distributional assumptions (e.g., GLMs, and some regularized models) can benefit from minimizing the skewness of numeric features. One popular transformation is the <a href="https://en.wikipedia.org/wiki/Power_transform#Yeo%E2%80%93Johnson_transformation">Yeo-Johnson transformation</a>.</p>
<p>The Yeo-Johnsontransformation is a statistical technique used to stabilize variance and make data more normally distributed, similar to the Box-Cox transformation but more flexible. Unlike Box-Cox, it can handle both positive and negative values, making it useful for real-world data that span zero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(happy <span class="sc">~</span> ., <span class="at">data =</span> data) <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_YeoJohnson</span>(<span class="fu">all_numeric</span>()) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:    1
predictor: 12</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Yeo-Johnson transformation on: all_numeric()</code></pre>
</div>
</div>
<section id="standardization" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="standardization">Standardization</h3>
</section>
<p>We will often want to standardize variables prior to our model fitting to put them on a common scale, typically with mean of zero and a standard deviation of one.</p>
<p>This prevents features with larger numeric ranges (e.g., income in dollars vs.&nbsp;age in years) from dominating distance-based methods (like k-NN, SVMs, or clustering). It can also help with optimization problems, may improve convergence and can help ensure that regularization penalties (like in ridge or lasso regression) are applied fairly across predictors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="categorical-feature-engineering" class="level2" style="color: yellow">
<h2 class="anchored" data-anchor-id="categorical-feature-engineering">Categorical Feature Engineering</h2>
</section>
<p>Many models require that the predictors take numeric form. There are exceptionssuch as tree-based models, however, even tree-based methods can benefit from preprocessing categorical features. The following sections will discuss a few of the more common approaches to engineer categorical features.</p>
<section id="lumping" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="lumping">Lumping</h3>
</section>
<p>Sometimes features will contain levels that have very few observations. For example, take a look at the work status variable <code>wrkstat</code>. There are 8 unique levels and some have relatively few observations. For example, <code>With A Job, But Not At Work Because Of Temporary Illness, Vacation, Strike</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span>(data, wrkstat) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  wrkstat                                                                      n
  &lt;fct&gt;                                                                    &lt;int&gt;
1 &lt;NA&gt;                                                                        10
2 With A Job, But Not At Work Because Of Temporary Illness, Vacation, Str…    61
3 In School                                                                   90
4 Other                                                                      113
5 Unemployed, Laid Off, Looking For Work                                     168
6 Keeping House                                                              292
7 Working Part Time                                                          319
8 Retired                                                                    796
9 Working Full Time                                                         1460</code></pre>
</div>
</div>
<p>Sometimes we can benefit from collapsing, or “lumping” these into a lesser number of categories. In the above examples, we may want to collapse all levels that are observed in less than 5% of the training sample into an <code>Other</code> category. We can use <code>step_other()</code> to do so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>lumping <span class="ot">&lt;-</span> <span class="fu">recipe</span>(happy <span class="sc">~</span> ., <span class="at">data =</span> data) <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(wrkstat, <span class="at">threshold =</span> <span class="fl">0.05</span>, </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">other =</span> <span class="st">"Other"</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply this blue print --&gt; you will learn about this at </span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the end of the chapter</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>apply_2_training <span class="ot">&lt;-</span> <span class="fu">prep</span>(lumping, <span class="at">training =</span> data) <span class="sc">%&gt;%</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(data)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co"># New distribution of Neighborhood</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span>(apply_2_training, wrkstat) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 2
  wrkstat                                    n
  &lt;fct&gt;                                  &lt;int&gt;
1 &lt;NA&gt;                                      10
2 Unemployed, Laid Off, Looking For Work   168
3 Other                                    264
4 Keeping House                            292
5 Working Part Time                        319
6 Retired                                  796
7 Working Full Time                       1460</code></pre>
</div>
</div>
<section id="one-hot-and-dummy-encoding" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="one-hot-and-dummy-encoding">One-Hot and Dummy Encoding</h3>
</section>
<p>As mentioned previously many models require that all features be numeric. Consequently, we need to intelligently transform any categorical variables into numeric representations so that these algorithms will work.</p>
<p>There are many ways to recode categorical variables as numeric (e.g., one-hot, ordinal, binary, sum, and Helmert).</p>
<p>One-hot encoding is a common method for converting categorical variables into a numerical format that machine learning algorithms can work with. Instead of assigning arbitrary numbers to categories (which could incorrectly imply an order), one-hot encoding creates a new binary (0/1) column for each category level. For a given observation, the column corresponding to its category is set to 1, and all others are set to 0.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/one_hot.webp" class="img-fluid figure-img" width="800"></p>
<figcaption>https://towardsdatascience.com/encoding-categorical-variables-one-hot-vs-dummy-encoding-6d5b9c46e2db/</figcaption>
</figure>
</div>
<p>However, this creates perfect collinearity which causes problems with some predictive modeling algorithms (e.g., ordinary linear regression and neural networks). Alternatively, we can create a full-rank encoding by dropping one of the levels (level <code>blue</code> has been dropped). This is referred to as dummy coding.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/dummy.webp" class="img-fluid figure-img" width="800"></p>
<figcaption>https://towardsdatascience.com/encoding-categorical-variables-one-hot-vs-dummy-encoding-6d5b9c46e2db/</figcaption>
</figure>
</div>
<p>Below is an example of one-hot encoding the predictors in our model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(happy <span class="sc">~</span> ., <span class="at">data =</span> data) <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_factor_predictors</span>(), <span class="at">one_hot =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:    1
predictor: 12</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Dummy variables from: all_factor_predictors()</code></pre>
</div>
</div>
<section id="workflow" class="level2" style="color: yellow">
<h2 style="color: yellow" class="anchored" data-anchor-id="workflow">Workflow</h2>
</section>
<p>When setting up your feature engineering workflow there is often a sensible order in which to perform these steps.</p>
<p>One possible sequence that avoids headaches is suggested by <span class="citation" data-cites="handson">Boehmke and Greenwell (<a href="#ref-handson" role="doc-biblioref">2019</a>)</span>:</p>
<ol type="1">
<li><p>Filter out zero or near-zero variance features.</p></li>
<li><p>Perform imputation if required.</p></li>
<li><p>Normalize to resolve numeric feature skewness.</p></li>
<li><p>Standardize (center and scale) numeric features.</p></li>
<li><p>Perform dimension reduction (e.g., PCA) on numeric features.</p></li>
<li><p>One-hot or dummy encode categorical features.</p></li>
</ol>
<section id="workflow-in-r" class="level3" style="color: orange">
<h3 class="anchored" data-anchor-id="workflow-in-r">Workflow in R</h3>
</section>
<p>To illustrate how this process works together in R code, let’s do a simple analysis using our example data, <strong>starting from scratch.</strong></p>
<p>The steps below simply re-downloads our data, selects the variables we want to keep, cleans up the missing data codes and does some basic relabeling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gssr)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>gss24 <span class="ot">&lt;-</span> <span class="fu">gss_get_yr</span>(<span class="dv">2024</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Fetching: https://gss.norc.org/documents/stata/2024_stata.zip</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>target <span class="ot">&lt;-</span> <span class="st">"happy"</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>features <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"age"</span>,     <span class="co"># age of participant</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sex"</span>,     <span class="co"># sex of participant</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race"</span>,    <span class="co"># race of participant</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"educ"</span>,    <span class="co"># highest education completed by participant</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"income"</span>,  <span class="co"># income of participant</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"childs"</span>,  <span class="co"># number of children participant has</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wrkstat"</span>, <span class="co"># work force status</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"marital"</span>, <span class="co"># marital status</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"born"</span>,    <span class="co"># whether or not participant was born in USA</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"partyid"</span>, <span class="co"># political party of participant</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"adults"</span>,  <span class="co"># num of fam members 18 or older</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"earnrs"</span>   <span class="co"># number of earners in family  </span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> gss24[,<span class="fu">c</span>(target, features)]</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a><span class="co"># define which varibles are categorical and continuous</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sex"</span>,<span class="st">"race"</span>, <span class="st">"educ"</span>, <span class="st">"wrkstat"</span>, <span class="st">"marital"</span>, <span class="st">"born"</span>, <span class="st">"partyid"</span>)</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>con_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"income"</span>,<span class="st">"childs"</span>,<span class="st">"adults"</span>,<span class="st">"earnrs"</span>,<span class="st">"happy"</span>)</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>capwords <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">strict =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    cap <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">paste</span>(<span class="fu">toupper</span>(<span class="fu">substring</span>(x, <span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>                  {x <span class="ot">&lt;-</span> <span class="fu">substring</span>(x, <span class="dv">2</span>); <span class="cf">if</span>(strict) <span class="fu">tolower</span>(x) <span class="cf">else</span> x},</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>                             <span class="at">sep =</span> <span class="st">""</span>, <span class="at">collapse =</span> <span class="st">" "</span> )</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="fu">strsplit</span>(x, <span class="at">split =</span> <span class="st">" "</span>), cap, <span class="at">USE.NAMES =</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(x)))</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert all missing to NA</span></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">everything</span>(), haven<span class="sc">::</span>zap_missing), </span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make all categorical variables factors and relabel nicely</span></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">all_of</span>(cat_vars), forcats<span class="sc">::</span>as_factor),</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">all_of</span>(con_vars), as.numeric),</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">all_of</span>(cat_vars), \(x) forcats<span class="sc">::</span><span class="fu">fct_relabel</span>(x, capwords, <span class="at">strict =</span> <span class="cn">TRUE</span>))</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data[<span class="sc">!</span><span class="fu">is.na</span>(data<span class="sc">$</span>happy),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now separate our data into a training and test set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("rsample")</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratified sampling with the rsample package</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data, <span class="at">prop =</span> <span class="fl">0.7</span>, <span class="at">strata =</span> <span class="st">"happy"</span>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>data_train  <span class="ot">&lt;-</span> <span class="fu">training</span>(split)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>data_test   <span class="ot">&lt;-</span> <span class="fu">testing</span>(split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we will formally introduce the <code>recipes</code> package.</p>
<p>The <strong><code>recipes</code></strong> package is part of the <code>tidymodels</code> framework and is designed for feature engineering. In machine learning, raw data usually isn’t ready to be used directly in a model—you might need to do all the things we discussed in these notes.</p>
<p>Instead of doing all these steps manually, <code>recipes</code> lets us define a sequence of preprocessing steps (called a recipe) that can be applied consistently to training and test data.</p>
<p>A recipe typically goes through three main stages:</p>
<section id="define-the-recipe" class="level4">
<h4 class="anchored" data-anchor-id="define-the-recipe">1. Define the recipe</h4>
<ul>
<li>Write down the <em>blueprint</em> of preprocessing steps you want to apply.<br>
</li>
<li>Example: “Impute missing values, standardize numeric predictors, and one-hot encode categorical variables.”<br>
</li>
<li>At this stage, the recipe only <strong>records what to do</strong>, not how to do it.</li>
</ul>
</section>
<section id="prep" class="level4">
<h4 class="anchored" data-anchor-id="prep">2. Prep</h4>
<ul>
<li>Use the training data to <strong>learn any parameters needed</strong> for preprocessing.<br>
</li>
<li>Example: Calculate means and standard deviations for standardization, determine category levels for encoding, or find values to impute.<br>
</li>
<li>After prepping, the recipe is ready to be applied consistently to new data.</li>
</ul>
</section>
<section id="bake" class="level4">
<h4 class="anchored" data-anchor-id="bake">3. Bake</h4>
<ul>
<li>Apply the recipe to a dataset (training, validation, or test).<br>
</li>
<li>This step actually transforms the data using the information learned during the <code>prep</code> stage.<br>
</li>
<li>The output is a processed dataset that can be used directly in a machine learning model.</li>
</ul>
<p>For example, the following defines <code>happy</code> as the target variable and then uses all the remaining columns as features based on <code>data_train</code>. We then:</p>
<ol type="1">
<li><p>Remove near-zero variance features that are categorical (aka nominal).</p></li>
<li><p>Impute missing data</p></li>
<li><p>Dummy encode our categorical features.</p></li>
<li><p>Center and scale (i.e., standardize) all numeric features</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>blueprint <span class="ot">&lt;-</span> <span class="fu">recipe</span>(happy <span class="sc">~</span> ., <span class="at">data =</span> data_train) <span class="sc">%&gt;%</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_nominal</span>())  <span class="sc">%&gt;%</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_bag</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_factor_predictors</span>(), <span class="at">one_hot =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>()) </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>blueprint</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:    1
predictor: 12</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Sparse, unbalanced variable filter on: all_nominal()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Bagged tree imputation for: all_predictors()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Dummy variables from: all_factor_predictors()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Centering for: all_numeric() -all_outcomes()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Scaling for: all_numeric() -all_outcomes()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># these are example steps you don't need to run for any reason other</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># than troubleshooting</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare &lt;- prep(blueprint, training = data_train)</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co"># baked_train &lt;- bake(prepare, new_data = data_train)</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co"># baked_test  &lt;- bake(prepare, new_data = data_test)</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="co"># baked_train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we can fit a model using the <code>caret</code> pacakge, using our blueprint as the first argument and then <code>caret</code> takes care of the rest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: lattice</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'caret'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:yardstick':

    precision, recall, sensitivity, specificity</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:rsample':

    calibration</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    lift</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify cross-validation plan</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>cv <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cv"</span>, <span class="co"># k-folds cross-validation", </span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">number =</span> <span class="dv">10</span>  <span class="co"># 10 folds</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create grid of hyperparameter values</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>hyper_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">k =</span> <span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">25</span>, <span class="at">by =</span> <span class="dv">1</span>))</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune a knn model using grid search</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>knn_fit <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  blueprint, </span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_train, </span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"knn"</span>, </span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> cv, </span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneGrid =</span> hyper_grid,</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="st">"RMSE"</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: !  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X4th.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: !  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.
!  The following column has zero variance so scaling cannot be used:
  educ_X1st.Grade.
ℹ Consider using ?step_zv (`?recipes::step_zv()`) to remove those columns
  before normalizing.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>knn_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>k-Nearest Neighbors 

2295 samples
  12 predictor

Recipe steps: nzv, impute_bag, dummy, center, scale 
Resampling: Cross-Validated (10 fold) 
Summary of sample sizes: 2066, 2066, 2066, 2064, 2066, 2065, ... 
Resampling results across tuning parameters:

  k   RMSE       Rsquared    MAE      
   2  0.7418063  0.03097989  0.5719579
   3  0.7052823  0.03088297  0.5546278
   4  0.6847273  0.03149323  0.5390046
   5  0.6771450  0.02897065  0.5329401
   6  0.6684619  0.03192580  0.5233915
   7  0.6594812  0.03810636  0.5159846
   8  0.6550279  0.03945877  0.5112249
   9  0.6529972  0.03903932  0.5081061
  10  0.6514761  0.03798039  0.5039809
  11  0.6495920  0.03878046  0.5006377
  12  0.6464377  0.04135895  0.4983083
  13  0.6449913  0.04153260  0.4959262
  14  0.6457968  0.03833580  0.4952235
  15  0.6455656  0.03708429  0.4940333
  16  0.6445642  0.03761307  0.4920747
  17  0.6428354  0.03999850  0.4895426
  18  0.6415509  0.04156203  0.4877497
  19  0.6410869  0.04199466  0.4861644
  20  0.6408229  0.04204207  0.4847307
  21  0.6409284  0.04098073  0.4844582
  22  0.6412205  0.04035344  0.4837011
  23  0.6408491  0.04051976  0.4822852
  24  0.6410824  0.03919338  0.4819184
  25  0.6411540  0.03858298  0.4816823

RMSE was used to select the optimal model using the smallest value.
The final value used for the model was k = 20.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(knn_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week2_5_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-handson" class="csl-entry" role="listitem">
Boehmke, Brad, and Brandon M Greenwell. 2019. <em>Hands-on Machine Learning with r</em>. Chapman; Hall/CRC.
</div>
<div id="ref-gssr" class="csl-entry" role="listitem">
Healy, Kieran. 2023. <em>Gssr: General Social Survey Data for Use in r</em>. <a href="http://kjhealy.github.io/gssr">http://kjhealy.github.io/gssr</a>.
</div>
<div id="ref-tidymodels" class="csl-entry" role="listitem">
Kuhn, Max, and Hadley Wickham. 2020. <em>Tidymodels: A Collection of Packages for Modeling and Machine Learning Using Tidyverse Principles.</em> <a href="https://www.tidymodels.org">https://www.tidymodels.org</a>.
</div>
<div id="ref-caret" class="csl-entry" role="listitem">
Kuhn, and Max. 2008. <span>“Building Predictive Models in r Using the Caret Package.”</span> <em>Journal of Statistical Software</em> 28 (5): 1–26. <a href="https://doi.org/10.18637/jss.v028.i05">https://doi.org/10.18637/jss.v028.i05</a>.
</div>
<div id="ref-rubin1976" class="csl-entry" role="listitem">
Rubin, Donald B. 1976. <span>“Inference and Missing Data.”</span> <em>Biometrika</em> 63 (3): 581–92.
</div>
<div id="ref-naniar" class="csl-entry" role="listitem">
Tierney, Nicholas, and Dianne Cook. 2023. <span>“Expanding Tidy Data Principles to Facilitate Missing Data Exploration, Visualization and Assessment of Imputations.”</span> <em>Journal of Statistical Software</em> 105 (7): 1–31. <a href="https://doi.org/10.18637/jss.v105.i07">https://doi.org/10.18637/jss.v105.i07</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>